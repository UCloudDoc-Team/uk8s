# 网络插件 升级

UK8S 提供的 CNI （Container Network Interface）基于 UCloud VPC 网络实现，因此会随着 VPC 的功能迭代同步更新版本，以提升容器网络的稳定性及性能。
UK8S提供 CNI 在线升级的功能，插件升级不会影响现有 Pod 的网络。CNI 升级成功后：

1. 其实现的网络特性将作用于新申请的 Pod；
2. 老的 Pod 如果也需要获得对应的网络特性，则需要滚动升级以触发 Pod 重建;

网络插件包括两个组件：CNI和ipamd。前者负责配置容器网络，后者负责管理 VPC IP 池子，二者可以互相独立升级。您可以在控制台分别看到这两个组件的管理卡片。

下面将介绍下如何在线升级这两个组件。

> ⚠️ 集群网络插件升级时，请勿进行服务发布等操作

## 1. CNI插件升级

CNI是部署在节点上面的二进制文件，升级或查看版本都需要在您的集群中运行任务。

需要查看当前集群的CNI版本，您可以进入「插件管理-网络插件」页面，找到「CNI插件升级」卡片，点击「开启」，我们会启动任务查询您集群的CNI版本：

![cni-update](/images/network/cni-update-open.png)

查询任务大约需要3分钟的执行时间，在此过程中请不要操作集群。查询完成之后，您就可以点击「管理集群插件版本」来查看您的CNI版本了：

![cni-update](/images/network/cni-update-manage.png)

您可以看到每个节点的CNI版本，并且可以对它们进行升级。您可以一次性升级一个节点，或者批量进行升级：

![cni-update](/images/network/cni-update.png)

升级CNI同样需要执行任务，升级过程约需要 1-3分钟，升级过程中「当前版本」字段会显示为「升级中」，升级完成后显示最新版本号。

如升级失败，可以再尝试「强制升级」，或与我们技术支持联系。部分节点由于版本原因，可能无法获取到「当前CNI版本」，直接点击强制升级即可。

建议先升级单台节点，如果升级成功，则再进行批量升级。当所有节点都升级成功后，可关闭插件升级服务，后续有升级需求时再开启。

如控制台页面无法查看 CNI 版本信息，请在集群中任一节点执行 `/opt/cni/bin/cnivpc version` 查看。

对于非维护版本的集群，无法将CNI升级到最新版本，只能升级到LTS（长期维护）版本。详见：[集群版本维护说明](/uk8s/version/maintain)。

## 2. ipamd插件升级

ipamd是通过Daemonset部署的，它的版本查询和升级不需要执行任务，可以马上完成。

ipamd是可选组件，它可以有效提高网络插件分配IP的效率，在新版本的集群中，ipamd都是默认开启的。详见：[CNI Ipamd预分配VPC IP实现原理和部署架构](/uk8s/network/ipamd)。

需要查看当前集群的ipamd版本，您可以进入「插件管理-网络插件」页面，找到「ipamd插件」卡片，应该可以看到当前ipamd版本和最新版本。

如果您的集群中没有部署ipamd，需要先点击「开启」部署ipamd：

![cni-update](/images/network/ipamd-enable.png)

如果您的ipamd不是最新版本，可以直接点击「升级版本」进行升级：

![cni-update](/images/network/ipamd-update.png)

对于非维护版本的集群，无法开启或升级ipamd。

## 3. 网络插件更新纪要

以下的版本更新纪要可能有延后性，如果您想获取最新的CNI更新日志以及所有源代码，请到我们的开源仓库查看：[uk8s-cni-vpc](https://github.com/ucloud/uk8s-cni-vpc)。

>️️ ⚠️ 带`-lts`后缀的版本表示长期维护版本，仅包括重大BUG的修复，不包括新功能。

| 版本    | 类型        | 更新说明                                                     | 发布时间       |
| ------- | ----------- | ------------------------------------------------------------ | -------------- |
| 1.3.2 | Bugfix | 1. 解决在ipamd和cni同时启动时，可能会出现同一个IP被分配给不同的Pod的问题。<br />2. 解决在BoltDB数据库文件损坏时，Pod会拿到不可用IP的问题。 | 2024年08月05日 |
| 1.3.1 | Bugfix | 解决在Linux 5.x内核上创建的Pod网络不通的问题。 | 2024年08月05日 |
| 1.3.0 | Feature | 1. 适配1.26集群<br />2. 分配pod ip前通过VPC检查可用性，防止Pod拿到不可用IP导致网络不通 | 2024年06月19日 |
| 1.2.3   | Bugfix      | 修复ipamd不存在时使用固定IP功能存在的问题。         | 2023年11月23日 |
| 1.2.2   | Feature     | 适配裸金属类型节点。                             | 2023年08月22日 |
| 1.2.1   | Bugfix      | 修复某些场景下pod ip可能被误分配到其他云主机的虚拟网卡上的问题。  | 2023年08月22日 |
| 1.2.0   | Feature     | 1. 安全起见，彻底去除CNI中GC相关逻辑，新增cnivpctl命令行，将GC和一些其他调试命令移动到命令行工具中。<br />2. 通过持久化IP池，修复ipamd异常退出后导致的IP泄漏问题。<br />3. 避免在使用network policy时pod路由规则可能被重复添加导致的报错。 | 2023年07月18日 |
| 1.0.4-lts | LTS | 1. 解决在ipamd和cni同时启动时，可能会出现同一个IP被分配给不同的Pod的问题。<br />2. 解决在BoltDB数据库文件损坏时，Pod会拿到不可用IP的问题。 | 2024年08月05日 |
| 1.0.3-lts   | LTS | 修复某些场景下pod ip可能被误分配到其他主机的虚拟网卡上的问题。 | 2023年08月22日 |
| 1.0.2   | Bugfix      | 在检测IP冲突时，忽略`EINTR`错误，以防止误报。                | 2023年01月16日 |
| 1.0.1   | Bugfix      | 修复ipamd申请IP时没有刷新token导致的调用失败问题。           | 2022年01月04日 |
| 1.0.0   | Feature     | 1. CNI正式开源，地址：[uk8s-cni-vpc](https://github.com/ucloud/uk8s-cni-vpc)。<br />2. 重构ipamd相关代码，增加水位控制、IP借调等相关特性。ipamd将作为默认组件。 | 2022年12月29日 |
| 22.05.1 | Enhancement | 根据 rfc5227 在 Pod 创建时对申请到的内网 IP 进行冲突检测，达到一定重试次数后，如果仍然冲突，会释放当前 IP，并重新申请 IP | 2022年05月30日 |
| 22.04.1 | Feature     | 将 ip_local_port_range 改为 32768 ~ 60999                    | 2022年04月01日 |
| 21.12.2 | Feature     | ipamd 支持开启 calico policy 特性，IP 会写入到 Pod 的 annotation，calico 可以通过感知该 IP 来及时下发规则 | 2021年12月28日 |
| 21.12.1 | Enhancement | 1. 优化 ipamd 申请 IP 流程，ipamd 会在申请到 IP 以后立刻发送 garp ；<br>2. 优化释放 IP 时候获取 mac 的流程。 | 2021年12月14日 |
| 21.10.1 | Bugfix      | 1. 修复固定 IP 意外释放导致 StatefulSet Pod 不可用的问题；<br>2. 修复 CNI 抢占文件锁超时导致释放 IP 失败的问题；<br>3. IPAMD 插件开启后，将默认使用其管理 IP。 | 2021年11月4日  |
| 21.07.1 | Bugfix      | 解决部分节点无法获取 CNI 版本问题                            | 2021年7月1日   |
| 21.06.1 | Feature     | 支持 Pod 固定 IP（[固定 IP 使用方法](/uk8s/network/static_ip)） | 2021年6月23日  |
| 21.01.3 | Bugfix      | 兼容开启了弹性网卡的UHost节点，解决其无法出外网的问题        | 2021年1月29日  |
| 21.01.2 | Feature     | 将 Pod 的默认 MTU 设置为1452                                 | 2021年1月15日  |
| 21.01.1 | Enhancement | ipamd 申请 IP 机制优化                                       | 2021年1月1日   |
| 20.07.1 | Enhancement | 支持 garp 机制，优化 Pod 网络首包延时问题                    | 2020年7月16日  |

文档更新可能滞后，最新版本请以产品页面为准。
