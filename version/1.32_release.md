## Kubernetes 1.32版本重要变更说明

### WatchList特性门控进阶至Beta，默认启用

通常大量List操作会导致控制面资源消耗显著增加，启用WatchListClient特性后，client-go客户端可以使用流式请求代替全量List，降低控制面资源消耗。kube-controller-manager组件默认启用该功能。更多信息，请参见[Enhancing Kubernetes API Server Efficiency with API Streaming](https://kubernetes.io/blog/2024/12/17/kube-apiserver-api-streaming/)。

### StatefulSetAutoDeletePVC特性门控在1.32进入GA

该特性提供对StatefulSet中PVC删除的精细控制，允许在StatefulSet明确不需要PVC时自动清理PVC，降低孤立PVC对StatefulSet的影响。更新StatefulSet和节点维护过程中不对PVC产生影响，不触发自动清理。

### 调度器的每个插件都集成QueueingHint回调函数

方便调度器获取Pod重新入队的建议，快速判断Pod是否需要重新入队，以减少不必要的调度重试，从而提升调度吞吐量。更多信息，请参见[QueueingHint Brings a New Possibility to Optimize Pod Scheduling](https://kubernetes.io/blog/2024/12/12/scheduler-queueinghint/)

### RecoverVolumeExpansionFailure特性门控进阶至Beta

PVC扩容失败时通常需要管理员介入手动恢复，恢复操作繁琐。该特性允许用户直接手动调小PVC的.spec.resources，有助于PVC快速恢复且数据不丢失。具体方式，请参见[Recovering from Failure when Expanding Volumes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#recovering-from-failure-when-expanding-volumes)。

- AuthorizeWithSelectors和AuthorizeNodeWithSelectors特性门控进阶至Beta，后者需要搭配前者使用。启用后，AuthorizeNodeWithSelectors允许节点鉴权器使用更细粒度的选择算符（例如fieldSelector和labelSelector）进行鉴权，提高了Kubernetes授权系统的灵活性。kubelet仅有最小权限，只能读取自己的节点对象和绑定到自己节点的Pod。更多信息，请参见Using Node Authorization。

### 优化JobController

极大提升Job的更新和删除效率，尤其是在大量使用Job的场景下。更多信息，请参见[#126567](https://github.com/kubernetes/kubernetes/pull/126567)、[#127228](https://github.com/kubernetes/kubernetes/pull/127228)和[#127378](https://github.com/kubernetes/kubernetes/pull/127378)。

### 优化kube-proxy

Service更新时使用fieldSelector: clusterIP!=None，以避免监听Headless Service，减少不必要的带宽占用。更多信息，请参见[#126769](https://github.com/kubernetes/kubernetes/pull/126769)。

### CRD中caBundle优化

在CustomResourceDefinition（CRD）中指定caBundle字段时，如果caBundle非空，但内容无效或不包含任何CA证书，那么该CRD将不会提供服务。CRD的caBundle设置为有效状态后，将不再允许通过更新操作将其变为无效或内容为空的状态，以避免中断CRD的正常服务。

### MatchLabelKeysInPodAffinity特性门控进阶至Beta

podAffinity和podAntiAffinity默认支持更为精细的配置字段[matchLabelKeys](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#matchlabelkeys)和[mismatchLabelKeys](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#mismatchlabelkeys)，以解决调度器在Deployment滚动更新期间无法区分新老Pod，继而导致调度结果不符合亲和性和反亲和性预期的问题。

### JobSuccessPolicy进阶至Beta

允许为Indexed Job配置成功策略。更多信息，请参见[Job Success Policy](https://kubernetes.io/docs/concepts/workloads/controllers/job/#success-policy)。

### RecursiveReadOnlyMounts进阶至Beta

允许在Pod的卷挂载上设置递归的只读属性，即以此种方式挂载的卷及其内部的所有子目录和文件都将被设置为只读状态。更多信息，请参见[Recursive read-only mounts](https://kubernetes.io/docs/concepts/storage/volumes/#recursive-read-only-mounts)。

### Pod spec优化

当Pod spec发生改变，但不涉及image字段的改动时，kubelet将不会重启容器，避免因非功能性配置更新而引起的不必要的Pod重启。

### HonorPVReclaimPolicy进阶至Beta

支持在PersistentVolume上添加Finalizer，以确保仅在删除对应的底层存储资源后才删除具有Delete回收策略的PersistentVolume。更多信息，请参见[PersistentVolume deletion protection finalizer](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolume-deletion-protection-finalizer)。

### kubectl debug支持配置自定义模板（Profile）调试Pod的信息。

更多信息，请参见[Kubernetes 1.31: Custom Profiling in Kubectl Debug Graduates to Beta](https://kubernetes.io/blog/2024/08/22/kubernetes-1-31-custom-profiling-kubectl-debug/)。

### 客户端支持WebSocket传输协议

Kubernetes客户端（例如 kubectl）中用于kubectl cp、kubectl attach、kubectl exec 和 kubectl port-forward命令的流式传输协议更新为更现代、更灵活的WebSocket流式传输协议。

- API Server提供从缓存中实现一致性读的能力，减少将请求透传到etcd，提升了List请求的效率。更多信息，请参见[Consistent Reads from Cache](https://kubernetes.io/blog/2024/08/15/consistent-read-from-cache-beta/)。

## 弃用api

- 内置的CephFS卷插件（kubernetes.io/cephfs）被移除，使用[CephFS CSI驱动](https://github.com/ceph/ceph-csi/)代替。如果您正在使用CephFS卷插件，请在集群升级到1.31改用新方案，并使用新的驱动重新部署应用。

- 内置CephRBD卷插件（kubernetes.io/rbd）被移除，使用[RBD CSI驱动](https://github.com/ceph/ceph-csi/)代替。如果您正在使用CephRBD卷插件，请在集群升级到1.31改用新方案，并使用新的驱动重新部署应用。

- CSIMigrationPortworx特性门控默认启用，支持将卷操作从旧的Portworx内嵌插件迁移到Portworx CSI插件。如果您正在使用Portworx作为存储解决方案，请在集群升级到1.31前在集群中安装并配置Portworx CSI插件。

- `flowcontrol.apiserver.k8s.io/v1beta3`版本的FlowSchema和PriorityLevelConfiguration在1.32版本中废弃。推荐迁移至`flowcontrol.apiserver.k8s.io/v1`API版本（自1.29起可用）。

- `flowcontrol.apiserver.k8s.io/v1`版本中PriorityLevelConfiguration的spec.limited.nominalConcurrencyShares字段在未指定时默认为30（如显式配置为0，则不会被更改为30）。

### 参考链接

- 关于Kubernetes 1.31和1.32完整的变更记录，请参见[CHANGELOG-1.31](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.31.md)、[CHANGELOG-1.32](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.32.md)。
