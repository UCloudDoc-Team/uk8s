# ULB 参数说明

本文主要描述用于创建 LoadBalancer 类型的 Service 时，与 ULB 相关的 Annotations 说明。

## 参数注意项

1. 目前除了外网 ULB 绑定的 EIP 的带宽值以外，其他参数暂时不支持修改，请谨慎配置。
2. 外网 ULB 绑定的 EIP 的带宽值，必须通过 Annotations 修改，Annotations 将会覆盖控制台修改的配置。


## 1. ULB 相关参数说明

**注意：Service创建之后，以下参数不允许修改！！！**

| 字段                                                                               | 默认值        | 说明                                                                                                                                                                                                                                                                                                                                                          |
| -------------------------------------------------------------------------------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| service.beta.kubernetes.io/ucloud-load-balancer-type                             | outer      | 负载均衡网络类型，枚举值为 inner / outer。                                                                                                                                                                                                                                                                                                                             |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-protocol                 | tcp        | VServer 协议类型，枚举值为 tcp / udp / http / https。                                                                                                                                                                                                                                                                                                                 |
| service.beta.kubernetes.io/ucloud-load-balancer-listentype                       | /          | 负载均衡类型，枚举值为 packetstransmit / requestproxy / application / network。<br>1. ULB 类型为请求代理，VServer 协议为 tcp：该参数配置为 requestproxy，vserver-protocol 配置为 tcp；<br>2. ULB 类型为请求代理，VServer 协议为 http / https：无需配置该参数，自动按照 vserver-protocol 配置；<br>3. ULB 类型为报文转发，VServer 协议为 tcp / udp：无需配置该参数，自动按照 vserver-protocol 配置。<br> 4. ULB类型为ALB，该参数配置为 application（仅24.03.13版本之后支持），vserver-protocol 可选 http / https；<br>5. ULB类型为NLB，该参数配置为network（仅24.12.24版本之后支持），vserver-protocol可选tcp / udp； <br />负载均衡类型及 VServer 协议类型详情说明请参见：[负载均衡类型](/ulb/fast/createulb/networktype) |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-method                   | roundrobin | VServer的负载均衡模式，枚举值为 roundrobin（轮询）、source（源地址）、consistenthash（一致性哈希）、sourceport（源地址计算端口）、consistenthashport（端口一致性哈希）、leastconn(最小连接数,clb4不支持)、backup(主备,alb独占)、sourcehash（源地址哈希，nlb独占）、weightleastconn（加权最小连接，nlb独占）。                                                                                                                                                                  |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-client-timeout           | 0/60       | 使用 ULB4 时，表示连接保持时间，单位为秒，取值 [60, 900]，0 表示禁用连接保持，默认为 0（不需要指定参数）。<br>使用 ULB7 时，表示空闲连接的回收时间，单位为秒，取值为 (0, 86400]，0 表示禁用连接保持，默认为 60。<br>指定参数后，persistence-type 不能为 none。                                                                                                                                                                                         |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-session-persistence-type | none       | 会话保持方式，枚举值为 none（关闭）、serverinsert（自动生成 KEY）、userdefined（用户自定义 KEY）。                                                                                                                                                                                                                                                                                         |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-ssl-port                 | /          | 开启 ssl 协议的端口，多个用 "," 分隔开，必须和 ssl-cert 同时指定。                                                                                                                                                                                                                                                                                                                 |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-ssl-cert                 | /          | ssl 证书 ID，必须和 ssl-port 同时指定，需要先将证书上传至 UCloud。<br>负载均衡所使用的 SSL 证书的管理，请参见 ULB 文档：[添加证书](/ulb/guide/certificate/addcertificate)                                                                                                                                                                                                                                |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-session-persistence-info | /          | 用户自定义 KEY，persistence-type 为 userdefined 时有效。                                                                                                                                                                                                                                                                                                               |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-monitor-type             | port       | 健康检查方式，枚举值为 port / path / customize。<br>请求代理型 TCP 协议仅支持 port，其他协议支持 port 和 path；报文转发型 TCP 协议仅支持 port，UDP 协议支持 port 和 customize；ALB支持Port，HTTP；NLB支持Port，UDP                                                                                                                                                                                                              |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-monitor-domain           | /          | clb7 的 monitor-type 为 path 时, 或者 alb 的 monitor-type 为 HTTP 时有效，指 http 检查域名。                                                                                                                                                                                                                                                                                                                        |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-monitor-path             | none          | clb7 的 monitor-type 为 path 时, 或者 alb 的 monitor-type 为 HTTP 时有效，指 http 检查路径。<br>默认值为空，表示检查根路径`/`；如要自定义路径，只需提供根路径后面的部分，如`health`或`status/ready`                                                                                                                                                                                                                                                                                                                        |
| service.beta.kubernetes.io/ucloud-load-balancer-subnet-id                        | VPC 默认子网   | 创建 ULB 所在子网，填写子网 ID，如 subnet-xxxxxxxx。                                                                                                                                                                                                                                                                                                                      |
| service.beta.kubernetes.io/ucloud-load-balancer-remove-unscheduled-backend       | true       | 移除不可被调度节点，枚举值 true / false，设置为 false 后节点不可调度时不会自动被 ULB 剔除。<br>仅在 21.04.1 及以后 cloudprovider 版本中支持。                                                                                                                                                                                                                                                           |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-monitor-reqmsg           | /          | UDP 健康检查发出的请求报文，仅在 protocol 设置为 udp 时生效。<br>仅在 21.05.1 及以后 cloudprovider 版本中支持。                                                                                                                                                                                                                                                                             |
| service.beta.kubernetes.io/ucloud-load-balancer-vserver-monitor-respmsg          | /          | UDP 健康检查请求应收到的响应报文，仅在 protocol 设置为 udp 时生效。<br>仅在 21.05.1 及以后 cloudprovider 版本中支持。                                                                                                                                                                                                                                                                          |
|service.beta.kubernetes.io/ucloud-load-balancer-paymode | month | alb和nlb付费模式，支持 month（按月付费）、year（按年付费）、dynamic（按时付费）。 关于ALB付费相关参见:[ALB 产品定价](/ulb/alb/buy/charge)。关于NLB付费相关参见：[NLB产品定价](https://docs.ucloud.cn/ulb/NLB/buy/charge)。 |
|service.beta.kubernetes.io/ucloud-load-balancer-quantity | 1 | alb和nlb付费时长，chargetype 为 dynamic 时无需填写 |
|service.beta.kubernetes.io/ucloud-load-balancer-firewall-id | / | 在创建CLB时，绑定防火墙。默认不进行绑定 |
|service.beta.kubernetes.io/ucloud-load-balancer-vserver-enable-direct-endpoint" | false| 开启后alb/nlb后端直接使用pod ip，仅 25.07.23 版本之后支持,仅vpc-cni支持）|

CloudProvider 版本查看及升级请参见：[CloudProvider 插件更新](/uk8s/service/cp_update)

## 2. 外网 ULB 绑定 EIP 相关参数说明

**注意：Service创建之后，以下参数仅`service.beta.kubernetes.io/ucloud-load-balancer-eip-bandwidth`可以修改，其它参数不允许修改！！！**

| 字段                                                                   | 默认值       | 说明                                                           |
| -------------------------------------------------------------------- | --------- | ------------------------------------------------------------ |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-paymode          | bandwidth | 计费模式，支持 traffic（流量计费）、bandwidth（带宽计费）、sharebandwidth（共享带宽）。  |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-sharebandwidthid | /         | 共享带宽 ID，仅在 eip-paymode 为 sharebandwidth 时生效。                 |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-bandwidth        | 2         | 外网带宽，单位为 Mbps。共享带宽模式下无需指定，或者配置为 0；流量计费模式下，该参数为流量计费 EIP 带宽上限。 |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-chargetype       | month     | 付费模式，支持 month（按月付费）、year（按年付费）、dynamic（按时付费）。                |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-quantity         | 1         | 付费时长，chargetype 为 dynamic 时无需填写。                             |
| service.beta.kubernetes.io/ucloud-load-balancer-eip-operator-name        | BGP/International         | 弹性IP线路，国际线路：International；BGP线路：Bgp；精品BGP：BGPPro；电信：Telecom。 默认值根据所处地域决定（华北（北京2）、上海、华南（广州）、华北（乌兰察布）为BGP，其他地域为International）<br>仅在 24.04.02 及以后 cloudprovider 版本中支持。                             |