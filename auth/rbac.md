# UK8S RBAC 授权管理

授权管理操作能由主账号或集群管理员进行，并且只能对该账号的子账号进行Kubernets集群资源授权。关于如何邀请子账号，请参考：[子用户](https://docs.ucloud.cn/uproject/user)。

子账号如果角色是管理员，也能对其他账号进行授权，但是需要主账号在IAM为其增加`iam:ListUsers`权限以让其能够查看别的子账号信息。

在开启授权管理后，用子账号登录UK8S控制台，可能会看到下面两个错误：

* `94020:您没有操作这个集群的权限，请联系集群所有者授权`：这表示您虽然有UK8S集群的IAM权限，但是缺少RBAC权限。请找主账号或集群管理员，在`授权管理`页面为您当前子账号授权即可。
* `94021:不允许操作这个资源`：这表示您已经被授权了，但是没有某个命名空间或资源的权限。例如管理员给您的权限是`开发者`，就无法查看集群的节点信息，当进入节点管理页面就会看到这种报错。

> ⚠️ 如果没有开启授权管理，子账号将不会受到Kubernetes RBAC授权限制，并且可以直接看到集群的管理凭证。
>
> ⚠️ 针对注销、冻结或封号的子账号，UK8S侧并不能自动撤销该账号的授权，此时凭证将会仍然可用。为了安全起见，需要手动在授权管理进行撤销。
>
> ⚠️ 目前不支持对授信账号进行授权管理。
>
> ⚠️ 如果是历史集群，管理凭证可能已经被子账号拿到并保存。为了安全建议立即开启授权管理并评估管理凭证是否已经泄漏。

## 授权说明

#### 角色

对于子账号授予的`角色&权限`。在Kubernetes中，它们实际上对应的是集群中的`ClusterRole`（暂不支持`Role`）。授权管理预置了一些角色来方便用户配置：

| 角色       | 权限                                                         |
| ---------- | ------------------------------------------------------------ |
| 管理员     | 所有命名空间资源和集群资源的读写权限                         |
| 只读管理员 | 所有命名空间资源和集群资源的只读权限                         |
| 开发者     | 所有或部分命名空间资源的读写权限，**无法读写Secrets敏感资源** |
| 只读开发者 | 所有或部分命名空间资源的只读权限，**无法读取Secrtes敏感资源** |
| 自定义     | 当上述权限无法满足要求时，可以通过指定ClusterRole来自定义权限<br />您需要先创建ClusterRole，详见：[ClusterRole](https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authorization-resources/cluster-role-v1/)<br />**注意：请谨慎授予`cluster-admin`权限，它类似超级管理员，拥有对所有资源的读写权限。** |

#### 权限

在Kubernetes中，资源一般分为两类：

- **命名空间资源**：一般包括工作负载、存储配置、集群伸缩等。例如Deployment、Pod、StatefulSet、ConfigMap等。
- **集群资源**：一般包括节点、存储类、命名空间等。例如Node、StorageClass、Namespace、CRD等。

如果选了命名空间（包括全选），将会在Kubernetes中进行`RoleBindings`创建。此时子账号将无法操作集群资源。

如果选择了`所有命令空间`，将会在Kubernetes中进行`ClusterRoleBindings`创建。

- 如果角色是`管理员`，子账号将可以操作集群所有资源。
- 如果角色是`开发者`，子账号可以操作命名空间资源但是无法操作集群资源。

如果子账号只被授予了`default`这个命名空间的权限，那么他在控制台就无法查看别的命名空间的资源了。如果子账号是只读权限，进行修改操作也会报错。

#### 控制台命令

子账号在控制台的命令操作（譬如：集群的`kubectl`控制台、 Pod的终端），也将会使用子账号自己的凭证。

* 子账号在集群列表页进入`kubectl`或者Pod的`终端`控制台，会在您的集群下创建一个Pod用于访问集群，该Pod会在子账号退出kubectl或者Pod的`终端`页面后被销毁。

* 为了防止滥用导致Pod过多，子账号的命令行Pod最多只能运行2小时，也就是说子账号使用`kubectl`或者Pod的`终端`有时长限制，超过时间需要重新打开。这个限制对主账号不生效。

* 如果不希望子账号使用`kubectl` 或者Pod的`终端`功能，可以在[UK8S IAM 授权管理](/uk8s/auth/IAM)中禁用`GetUK8STerminalToken`这个权限。

## 开启授权

在集群的`授权管理`页面，可以进行集群的RBAC授权管理操作。如果集群是历史集群，需要手动开启授权管理功能。

![auth](/images/auth/rbac_list.png)

## 创建授权

在新增授权页面，首先需要选择`授权对象`，这里会列出当前账号的所有子账号进行筛选，注意同一个子账号在同一集群中只能被授权一次，如果您需要更改账号的权限，请使用`修改权限`功能。

在选择角色之前，需要先选择`授权命名空间`，它将决定子账号可以操作哪些命名空间的资源。

![auth](/images/auth/rbac_create.png)

在创建授权之后，子账号就能通过UK8S控制台或独立的凭证来访问UK8S中的资源了。子账号登录控制台可以看到自己的独立凭证。这个凭证不同于集群的管理凭证，是为当前子账号单独颁发的，并且主账号随时可以对这个凭证进行撤销或刷新。

## 刷新凭证

每个凭证都有自己的有效时间。当凭证过期时，子账号将无法再通过凭证访问集群，这时候主账号需要对凭证进行刷新操作：

![auth](/images/auth/rbac_refresh.png)

在凭证快要过期时，我们会提示您尽快刷新凭证。如果您不希望频繁刷新凭证，请选择尽量长的凭证过期时间。

## 修改权限

已经授权的用户是可以对它的命名空间或权限进行修改的：

![auth](/images/auth/rbac_update.png)

修改之后新的权限会立即生效（会重新创建RoleBinding或ClusterRoleBinding），并且凭证不会发生改变。

## 撤销授权

您可以随时撤销某个子账号的授权：

![auth](/images/auth/rbac_delete.png)

在授权撤销之后，子账号将无法继续访问或操作UK8S中的资源了。他的凭证也将会无法使用。

## 子账号创建的集群

如果集群是通过子账号创建的，我们会默认给子账号创建一个管理员权限，并且该权限无法被撤销或更改。

子账号作为集群创建者也可以为其他子账号进行RBAC授权。
