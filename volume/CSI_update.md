# CSI更新

> 在操作CSI更新之前，请务必仔细阅读下面的注意事项，如果有疑问，请咨询我们的技术支持。

## 1. 注意事项

- 集群进行存储插件升级时，**需要操作k8s关键组件**，请在业务低谷期操作，并且请勿进行服务发布。
- **切勿自行通过修改CSI的image的方式进行升级，否则CSI将无法工作。**请一定在控制台完成CSI的升级。
- 如果集群版本不在我们的维护版本之内，控制台将无法直接进行升级，参见：[UK8S版本维护说明](/uk8s/version/maintain.md)。
- **22.09.1**： **如果要使用RSSD云盘，请将CSI升级到`22.09.1`或以上的版本**，详情见[RSSD云盘挂载问题](/uk8s/troubleshooting/rssd_attachment)。
- **21.09.1**： 老版本升级到`21.09.1`或者以上的版本，会造成使用US3/UFile的pod挂载点失效，如果您的业务使用了US3/UFile，请务必确认当前版本，如有疑问，请与我们技术支持联系。


## 2. 版本查看及插件升级

在 UK8S 集群控制台管理页面「插件-存储插件」页面，开启 CSI 存储插件升级功能，开启 CSI 插件功能会在集群中执⾏ CSI 插件查询任务，⼤约需要 3
分钟，在此过程中请不要操作集群。升级功能开启后，即可看到 CSI 插件版本信息，点击「升级 CSI」即可进行升级。

升级过程约需要 1 分钟，升级过程中「当前版本」字段会显示为「升级中」，升级完成后显示最新版本号，如升级失败，请与我们技术支持联系。

当所有节点都升级成功后，可关闭插件升级服务，后续有升级需求时再开启。

## 3. 手动升级

如果集群版本不在我们的维护版本之内，您可以手动升级csi，请执行下面的命令(仅能升级到旧版本，不建议用RSSD云盘)：

#### UDisk CSI升级
```bash
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/volume/udisk.21.11.3-lts/csi-controller.yml
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/volume/udisk.21.11.3-lts/csi-node.yml
```

####  UFile CSI升级
```bash
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/volume/us3.21.11.2/csi-controller.yml
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/volume/us3.21.11.2/csi-node.yml
```

## 4. 变更记录
版本名称中带**se**的表明是我们自研的调度扩展组件版本，用于支持UDisk的调度,详情见[RSSD云盘挂载问题](/uk8s/troubleshooting/rssd_attachment)。其升级方式也是在 UK8S 集群控制台管理页面「插件-存储插件」页面点击「升级 CSI」按钮。

| 版本        | 更新时间   | 更新内容                                                     |
| ----------- | ---------- | ------------------------------------------------------------ |
| **25.08.21**| 2025.08.21 | 1. 支持ESSD云盘; <br>2. 修复`/var/lib/kubelet`目录下挂载传播导致的挂载点泄漏问题 |
| **25.03.31**| 2025.03.31 | 对 unix socket `/csi/csi.sock` 发送 CSI 健康检查请求，验证存储插件服务的可用性 |
| **se25.02.13**| 2025.02.13 | 修复**se25.01.07**中的bug：兼容pvc和pv的storageclass不一致的极端情况  |
| **25.01.16**| 2025.01.16 | udisk云盘以10g为计费单位，不满10g按10g计算，超过10g向上取整到10的整数倍  |
|  **se25.01.16** | 2025.01.16 | 支持RSSD云盘跨Rdma Cluster挂载云主机 |
| **se25.01.07** | 2025.01.07 | Pod调度时，限制主机云盘数量，并禁止调度至迁移中的主机(此版本存在不兼容pvc和pv的storageclass不一致的bug，该bug在**se25.02.13**中修复) |
| **24.10.08** | 2024.10.08 | 支持跨项目挂载us3 bucket |
| **24.08.14** | 2024.08.14 | 修复裸金属机器挂载云盘时的校验错误的问题 |
| **24.07.18** | 2024.07.18 | 挂载云盘时增加校验，防止在管理信息错误的情况下进行挂载 |
| **24.07.01** | 2024.07.01 | 下线了API调用监控指标上报，用户侧无影响 |
| **24.06.07** | 2024.06.07 | 解决同时卸载多块云盘时偶发卸载失败的问题 |
| **23.09.12** | 2023.09.12 | 1. 支持挂载us3 bucket指定目录; <br> 2. 修复容器中非root用户可能无法访问us3控制台创建的文件的问题 |
| **23.07.24** | 2023.08.01 |  RSSD云盘支持裸金属 |
| **22.09.1** | 2022.09.17 | 动态调度RSSD云盘，以解决[RSSD云盘挂载问题](/uk8s/troubleshooting/rssd_attachment) |
| **21.11.3-lts** | 2024.12.16 | 基于21.11.2版本，解决同时卸载多块云盘时偶发卸载失败的问题 |
| **21.11.2** | 2021.11.22 | 1. csi udisk支持方舟模式; <br>2. csi udisk支持指定业务组; <br>3. 优化us3 挂载参数 |
| **21.11.1** | 2021.11.04 | 1. 适配了 s3fs 返回成功而实际挂载失败的情况；<br>2. 修复因 US3 公私钥长度变化导致的挂载失败；<br>3. 始终通过节点 us3lancher 服务操作挂载 |
| **21.09.1** | 2021.09.07 | 将s3fs挂载操作放在Node上进行，**使用US3/UFile存储注意，升级到此版本会造成使用US3/UFile的pod挂载点失效；此版本要求Kubernetes版本不低于1.18**                                |
| **21.08.1** | 2021.08.12 | 优化 CSI 插件调度机制，避免被驱逐                            |
| **21.07.1** | 2021.07.05 | 支持云盘裸金属                                               |
| **21.04.1** | 2021.04.28 | 支持 UDisk 相关参数暴露在 Kubelet Metrics 中                 |
| **21.03.1** | 2021.03.15 | 解决节点被删除后，volumeattachment 未被删除导致存储无法卸载的问题 |
| **21.01.1** | 2021.01.13 | UDisk的起始大小变更为1GB                                     |
| **20.10.1** | 2020.10.14 | 支持CSI限制节点最大可挂载卷的数量<br>避免UCloud API客户端可能产生的并发竞争行为 |
